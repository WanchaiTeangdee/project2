<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | U-Nai Dee</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }
        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        .dashboard-header h1 {
            font-size: 42px;
            margin: 0 0 10px 0;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 7px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 16px;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .role-badge i { color: #ffffff; }
        .role-badge:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(37,99,235,0.45); }
        .role-badge:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.35), 0 6px 16px rgba(37,99,235,0.45); }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        .stat-card .label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .dashboard-section {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .dashboard-section h2 {
            margin: 0 0 20px 0;
            font-size: 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table th {
            background: #f3f4f6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
        }
        table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        table tr:hover {
            background: #f9fafb;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-edit {
            background: #2563eb;
            color: white;
        }
        .btn-delete {
            background: #dc2626;
            color: white;
        }
        .btn-view {
            background: #059669;
            color: white;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 90%;
            animation: slideUp 0.3s ease;
        }
        .modal-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1f2937;
        }
        .modal-body {
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 14px;
        }
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.2s ease;
            background: white;
        }
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .modal-btn {
            padding: 10px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .modal-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .modal-btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        .modal-btn-secondary:hover {
            background: #d1d5db;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body style="background: linear-gradient(135deg, #f0f4f8 0%, #e5e7eb 100%);min-height:100vh">
    <header class="site-header" style="background:white;box-shadow:0 2px 8px rgba(0,0,0,0.1)">
        <div class="container" style="display:flex;align-items:center;justify-content:space-between;padding:12px 20px">
            <h1 class="brand" style="color:#3b82f6;font-size:20px;margin:0"><i class="fas fa-building"></i> U-Nai Dee</h1>
            <nav style="display:flex;gap:15px">
                <a href="index.html" ><i class="fas fa-city"></i> ‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î</a>
                <a href="house.html" ><i class="fas fa-home"></i> ‡∏ö‡πâ‡∏≤‡∏ô</a>
            </nav>
            <div class="user-area" id="user-area" style="display:flex;align-items:center;gap:10px">            
                <div class="role-badge" id="role-badge-nav">Loading...</div>
                <a href="dashboard.html" class="btn" style="background:#059669;color:#2563eb">üìä Dashboard</a>
                <button onclick="auth.logoutUser(); window.location.href='index.html'" class="btn" style="background:transparent;color:#6b7280;padding:8px 16px;border:none;cursor:pointer;font-weight:500">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
            
        </div>
    </header>

    <main class="dashboard-container">
        <div class="dashboard-header" style="text-align:center;margin-bottom:30px">
            <h1 style="color:#1f2937;font-size:36px;margin:0"><i class="fas fa-chart-line"></i> Dashboard</h1>
        </div>

        <div class="stats-grid" id="stats-grid">
            <!-- Stats will be inserted here -->
        </div>
        
        <!-- Owner: Add New Listing -->
        <div id="owner-add-listing" style="display:none;margin-bottom:20px">
            <div class="dashboard-section">
                <h2><i class="fas fa-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤</h2>
                <button class="btn" onclick="openAddListingModal()" style="background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;padding:12px 30px;border-radius:8px;font-weight:600;width:100%;max-width:300px">
                    <i class="fas fa-home"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>
        
        <!-- Admin: Quick Access to Storage Viewer -->
        <div id="admin-storage-link" style="display:none;text-align:center;margin-bottom:20px">
            <a href="view-storage.html" class="btn" style="background:linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);color:white;padding:12px 30px;text-decoration:none;border-radius:8px;display:inline-block;font-weight:600">
                <i class="fas fa-database"></i> ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• localStorage
            </a>
        </div>

        <!-- Admin: All listings -->
        <div class="dashboard-section" id="admin-listings" style="display:none">
            <h2><i class="fas fa-building"></i> ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <div class="table-container">
                <table id="listings-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th>‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                            <th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</th>
                            <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="listings-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin/Owner: Bookings -->
        <div class="dashboard-section" id="bookings-section" style="display:none">
            <h2><i class="fas fa-clipboard-list"></i> ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <div class="table-container">
                <table id="bookings-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>‡∏£‡∏π‡∏õ‡∏õ‡∏Å</th>
                            <th>‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</th>
                            <th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th>
                            <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                            <th>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</th>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á</th>
                            <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="bookings-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin: All users -->
        <div class="dashboard-section" id="admin-users" style="display:none">
            <h2><i class="fas fa-users"></i> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <div class="table-container">
                <table id="users-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
                            <th>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                            <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin: Owner Requests -->
        <div class="dashboard-section" id="admin-owner-requests" style="display:none">
            <h2>üì® ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πà‡∏≤</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠</th>
                            <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="owner-requests-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin: User Reports/Contact -->
        <div class="dashboard-section" id="admin-reports" style="display:none">
            <h2>üì¢ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤/‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody id="reports-tbody">
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Role Change Modal -->
    <div id="roleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                ‚úèÔ∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                    <input type="text" id="modalUsername" readonly style="width:100%;padding:12px 15px;border:2px solid #e5e7eb;border-radius:8px;background:#f9fafb;color:#6b7280">
                </div>
                <div class="form-group">
                    <label>üé≠ ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                    <input type="text" id="modalCurrentRole" readonly style="width:100%;padding:12px 15px;border:2px solid #e5e7eb;border-radius:8px;background:#f9fafb;color:#6b7280">
                </div>
                <div class="form-group">
                    <label>üîÑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏´‡∏°‡πà</label>
                    <select id="modalNewRole">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó --</option>
                        <option value="customer">üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Customer)</option>
                        <option value="owner">üè† ‡∏ú‡∏π‡πâ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πà‡∏≤ (Owner)</option>
                        <option value="admin">‚öôÔ∏è Admin (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeRoleModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="modal-btn modal-btn-primary" onclick="submitRoleChange()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                    <input type="text" id="editModalUsername" readonly style="width:100%;padding:12px 15px;border:2px solid #e5e7eb;border-radius:8px;background:#f9fafb;color:#6b7280">
                    <small style="color:#6b7280;font-size:12px">* ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</small>
                </div>
                <div class="form-group">
                    <label>üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" id="editModalEmail" required style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px;background:#fff;color:#1f2937">
                </div>
                <div class="form-group">
                    <label>üé≠ ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                    <select id="editModalRole" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px;background:#fff;color:#1f2937">
                        <option value="customer">üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Customer)</option>
                        <option value="owner">üè† ‡∏ú‡∏π‡πâ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πà‡∏≤ (Owner)</option>
                        <option value="admin">‚öôÔ∏è Admin (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üîë ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                    <input type="password" id="editModalPassword" placeholder="‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px;background:#fff;color:#1f2937">
                    <small style="color:#6b7280;font-size:12px">* ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</small>
                </div>
                <div class="form-group">
                    <label>üîë ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                    <input type="password" id="editModalConfirmPassword" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px;background:#fff;color:#1f2937">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeEditUserModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="modal-btn modal-btn-primary" onclick="submitEditUser()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Add Listing Modal -->
    <div id="addListingModal" class="modal">
        <div class="modal-content" style="max-width:700px;max-height:90vh;overflow-y:auto">
            <div class="modal-header">
                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤
            </div>
            <div class="modal-body">
                <form id="addListingForm">
                    <div class="form-group">
                        <label>üè∑Ô∏è ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å *</label>
                        <input type="text" id="listingName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î‡∏´‡∏£‡∏π ‡πÉ‡∏à‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px">
                    </div>
                    
                    <div class="form-group">
                        <label>üè† ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó *</label>
                        <select id="listingType" required style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>
                            <option value="condo">üè¢ Condo (‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î)</option>
                            <option value="house">üè° House (‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà *</label>
                        <input type="text" id="listingLocation" required placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó, ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px">
                    </div>
                    
                    <div class="form-group">
                        <label>üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó) *</label>
                        <input type="number" id="listingPrice" required placeholder="‡πÄ‡∏ä‡πà‡∏ô: 15000" min="0" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px">
                    </div>
                    
                    <div class="form-group">
                        <label>ÔøΩ ‡∏£‡∏π‡∏õ‡∏õ‡∏Å *</label>
                        <input type="file" id="listingCoverFile" accept="image/*" style="width:100%;padding:10px;border:2px solid #3b82f6;border-radius:8px;background:#fff" />
                        <small style="color:#6b7280;font-size:12px;display:block;margin-top:6px">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ &lt; 2MB). ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏õ‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</small>
                        <input type="url" id="listingCoverUrl" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏õ‡∏Å ‡πÄ‡∏ä‡πà‡∏ô https://example.com/cover.jpg" style="margin-top:8px;width:100%;padding:12px 15px;border:2px solid #e5e7eb;border-radius:8px">
                        <div id="listingCoverPreview" style="margin-top:10px;display:none">
                            <img id="listingCoverPreviewImg" src="" alt="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏õ‡∏Å" style="max-width:100%;border-radius:8px;border:1px solid #e5e7eb;object-fit:cover;max-height:220px" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                        <input type="file" id="listingImageFile" accept="image/*" style="width:100%;padding:10px;border:2px solid #3b82f6;border-radius:8px;background:#fff" />
                        <small style="color:#6b7280;font-size:12px;display:block;margin-top:6px">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ &lt; 2MB). ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</small>
                        <input type="url" id="listingImageUrl" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô https://example.com/image.jpg" style="margin-top:8px;width:100%;padding:12px 15px;border:2px solid #e5e7eb;border-radius:8px">
                        <div id="listingImagePreview" style="margin-top:10px;display:none">
                            <img id="listingImagePreviewImg" src="" alt="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" style="max-width:100%;border-radius:8px;border:1px solid #e5e7eb;object-fit:cover;max-height:220px" />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î *</label>
                        <textarea id="listingDescription" required placeholder="‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å..." rows="4" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px;resize:vertical"></textarea>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                        <div class="form-group">
                            <label>üõèÔ∏è ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô *</label>
                            <input type="number" id="listingBedrooms" required min="0" value="1" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px">
                        </div>
                        <div class="form-group">
                            <label>üöø ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥ *</label>
                            <input type="number" id="listingBathrooms" required min="0" value="1" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>üìè ‡∏Ç‡∏ô‡∏≤‡∏î (‡∏ï‡∏£.‡∏°.) *</label>
                        <input type="number" id="listingSize" required min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô: 45" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px">
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                        <div class="form-group">
                            <label>üó∫Ô∏è ‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î (Latitude) *</label>
                            <input type="number" id="listingLat" required step="any" placeholder="13.7563" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px">
                        </div>
                        <div class="form-group">
                            <label>üó∫Ô∏è ‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î (Longitude) *</label>
                            <input type="number" id="listingLng" required step="any" placeholder="100.5018" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px">
                        </div>
                    </div>
                    <small style="color:#6b7280;font-size:12px;display:block;margin-top:-10px">
                        üí° ‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà <a href="https://www.google.com/maps" target="_blank" style="color:#3b82f6">Google Maps</a> (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‚Üí ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î)
                    </small>
                    
                    <div class="form-group">
                        <label>‚ú® ‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å</label>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" class="listing-amenity" value="Wi-Fi"> Wi-Fi
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" class="listing-amenity" value="‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ"> ‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" class="listing-amenity" value="‡∏™‡∏£‡∏∞‡∏ß‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥"> ‡∏™‡∏£‡∏∞‡∏ß‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" class="listing-amenity" value="‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡∏™"> ‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡∏™
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" class="listing-amenity" value="‡πÅ‡∏≠‡∏£‡πå"> ‡πÅ‡∏≠‡∏£‡πå
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" class="listing-amenity" value="‡∏£‡∏õ‡∏†. 24 ‡∏ä‡∏°."> ‡∏£‡∏õ‡∏†. 24 ‡∏ä‡∏°.
                            </label>
                            <!-- ‡∏≠‡∏∑‡πà‡∏ô‡πÜ -->
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" id="amenityOther"> ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                            </label>
                            <div id="amenities-other-wrapper" style="display:none;margin-top:10px;grid-column:1 / -1">
                                <input type="text" id="listingAmenitiesOther" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤, ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÑ‡∏î‡πâ" style="width:100%;padding:10px 12px;border:1.5px solid #3b82f6;border-radius:8px;background:#fff;color:#1f2937">
                                <small style="color:#6b7280;display:block;margin-top:6px">‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡∏Ñ‡∏±‡πà‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ (,)</small>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background:#f0f9ff;padding:15px;border-radius:8px;border:2px solid #3b82f6;margin-top:20px">
                        <h4 style="margin:0 0 10px 0;color:#1e40af">üìû ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h4>
                        <div class="form-group">
                            <label>üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ *</label>
                            <input type="text" id="ownerName" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px">
                        </div>
                        <div class="form-group">
                            <label>üì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ *</label>
                            <input type="tel" id="ownerPhone" required placeholder="0812345678" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px">
                        </div>
                        <div class="form-group">
                            <label><i class="fab fa-line"></i> LINE ID</label>
                            <input type="text" id="ownerLine" placeholder="@yourline" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px">
                            <small style="color:#6b7280;font-size:12px">* ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</small>
                        </div>
                        <div class="form-group">
                            <label><i class="fab fa-facebook"></i> Facebook</label>
                            <input type="text" id="ownerFacebook" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠ Facebook" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px">
                            <small style="color:#6b7280;font-size:12px">* ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</small>
                        </div>
                        <div class="form-group">
                            <label>üìù ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                            <input type="text" id="ownerOtherContact" placeholder="‡πÄ‡∏ä‡πà‡∏ô Email, IG, Website" style="width:100%;padding:12px 15px;border:2px solid #3b82f6;border-radius:8px">
                            <small style="color:#6b7280;font-size:12px">* ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="closeAddListingModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="modal-btn modal-btn-primary" onclick="submitAddListing()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
            </div>
        </div>
    </div>
    
    <!-- Chat Modal for Dashboard -->
    <div id="chat-modal-dashboard" class="modal" aria-hidden="true" style="z-index:9999;">
        <div class="modal-content" style="max-width:420px;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;">
            <div class="modal-header" style="font-size:20px;font-weight:600;">üí¨ ‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                <button onclick="closeChatModalDashboard()" style="float:right;font-size:22px;background:none;border:none;cursor:pointer">√ó</button>
            </div>
            <div id="chat-messages-dashboard" style="flex:1 1 0;min-height:200px;max-height:350px;overflow-y:auto;padding:10px 0 10px 0;"></div>
            <form id="chat-form-dashboard" style="display:flex;gap:8px;margin-top:10px;">
                <input id="chat-input-dashboard" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." autocomplete="off" style="flex:1 1 0;padding:10px 12px;border-radius:8px;border:1.5px solid #e5e7eb;">
                <button type="submit" class="btn" style="background:#2563eb;color:white;">‡∏™‡πà‡∏á</button>
            </form>
        </div>
    </div>

    <!-- Modal: Admin Reply to Report -->
    <div id="reply-report-modal" class="modal" style="display:none;z-index:9999;">
        <div class="modal-content" style="max-width:420px;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;">
            <div class="modal-header" style="font-size:20px;font-weight:600;">‚úâÔ∏è ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                <button onclick="closeReplyReportModal()" style="float:right;font-size:22px;background:none;border:none;cursor:pointer">√ó</button>
            </div>
            <div style="margin-bottom:10px;color:#374151;font-size:15px;">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:<br><span id="reply-report-message" style="display:block;margin-top:6px;background:#f3f4f6;padding:10px;border-radius:8px;"></span></div>
            <textarea id="reply-report-reply" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö..." rows="4" style="width:100%;padding:12px;border-radius:8px;border:1.5px solid #e5e7eb;"></textarea>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;">
                <button type="button" class="btn" onclick="closeReplyReportModal()" style="background:#6b7280;color:white">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn" onclick="submitReplyReport()" style="background:#059669;color:white">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal" style="display:none">
        <div class="modal-content" style="max-width:500px">
            <button class="modal-close" onclick="closeProfileModal()" aria-label="‡∏õ‡∏¥‡∏î">√ó</button>
            <h3 style="margin:0 0 20px 0;font-size:24px">üë§ ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
            <!-- View Mode -->
            <div id="profile-view-mode">
                <div style="background:#f9fafb;padding:20px;border-radius:12px;margin-bottom:20px">
                    <div style="margin-bottom:15px">
                        <label style="display:block;font-weight:600;margin-bottom:5px;color:#374151;font-size:14px">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                        <input type="text" id="profile-username" readonly style="width:100%;padding:10px 12px;border:1.5px solid #e5e7eb;border-radius:8px;background:#fff;color:#1f2937">
                    </div>
                    <div style="margin-bottom:15px">
                        <label style="display:block;font-weight:600;margin-bottom:5px;color:#374151;font-size:14px">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                        <input type="text" id="profile-email" readonly style="width:100%;padding:10px 12px;border:1.5px solid #e5e7eb;border-radius:8px;background:#fff;color:#1f2937">
                    </div>
                    <div style="margin-bottom:15px">
                        <label style="display:block;font-weight:600;margin-bottom:5px;color:#374151;font-size:14px">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                        <input type="text" id="profile-role" readonly style="width:100%;padding:10px 12px;border:1.5px solid #e5e7eb;border-radius:8px;background:#fff;color:#1f2937">
                    </div>
                    <div>
                        <label style="display:block;font-weight:600;margin-bottom:5px;color:#374151;font-size:14px">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà</label>
                        <input type="text" id="profile-created" readonly style="width:100%;padding:10px 12px;border:1.5px solid #e5e7eb;border-radius:8px;background:#fff;color:#1f2937">
                    </div>
                </div>
                <div style="display:flex;gap:10px;justify-content:flex-end">
                    <button class="btn" onclick="showEditProfile()" style="background:#2563eb;color:white"><i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
                    <button class="btn" onclick="closeProfileModal()">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
            <!-- Edit Mode -->
            <div id="profile-edit-mode" style="display:none">
                <form id="profile-edit-form">
                    <div style="background:#f9fafb;padding:20px;border-radius:12px;margin-bottom:20px">
                        <div style="margin-bottom:15px">
                            <label style="display:block;font-weight:600;margin-bottom:5px;color:#374151;font-size:14px">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                            <input type="text" id="edit-profile-username" readonly style="width:100%;padding:10px 12px;border:1.5px solid #e5e7eb;border-radius:8px;background:#e5e7eb;color:#6b7280;cursor:not-allowed">
                            <small style="color:#6b7280;font-size:12px">* ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</small>
                        </div>
                        <div style="margin-bottom:15px">
                            <label style="display:block;font-weight:600;margin-bottom:5px;color:#374151;font-size:14px">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                            <input type="email" id="edit-profile-email" required style="width:100%;padding:10px 12px;border:1.5px solid #3b82f6;border-radius:8px;background:#fff;color:#1f2937">
                        </div>
                        <div style="margin-bottom:15px">
                            <label style="display:block;font-weight:600;margin-bottom:5px;color:#374151;font-size:14px">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                            <input type="password" id="edit-profile-password" placeholder="‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô" style="width:100%;padding:10px 12px;border:1.5px solid #3b82f6;border-radius:8px;background:#fff;color:#1f2937">
                        </div>
                        <div>
                            <label style="display:block;font-weight:600;margin-bottom:5px;color:#374151;font-size:14px">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                            <input type="password" id="edit-profile-confirm-password" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" style="width:100%;padding:10px 12px;border:1.5px solid #3b82f6;border-radius:8px;background:#fff;color:#1f2937">
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;justify-content:flex-end">
                        <button type="button" id="cancel-edit-profile-btn" class="btn" style="background:#6b7280;color:white;padding:10px 20px;border-radius:8px">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="btn" style="background:#10b981;color:white;padding:10px 20px;border-radius:8px">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        const user = auth.getLoggedInUser()
        
        // Check permission
        if(!user || (user.role !== 'admin' && user.role !== 'owner')) {
            alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ')
            window.location.href = 'index.html'
        }

        // Display role
        const roleBadgeNav = document.getElementById('role-badge-nav')
        if(roleBadgeNav) {
            const displayName = user.displayName || user.name || user.username || ''
            const roleLabels = {
                admin: '<i class="fas fa-cog"></i> admin (Admin)',
                owner: `üè† ${displayName || '‡∏ú‡∏π‡πâ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πà‡∏≤'} (‡∏ú‡∏π‡πâ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πà‡∏≤)`,
                customer: '<i class="fas fa-user"></i> customer (Customer)'
            }

            // Set label and content
            roleBadgeNav.innerHTML = roleLabels[user.role] || user.role
            // Make it behave like a button
            roleBadgeNav.setAttribute('role', 'button')
            roleBadgeNav.setAttribute('tabindex', '0')
            roleBadgeNav.setAttribute('aria-label', '‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô')
            // Click opens profile
            roleBadgeNav.addEventListener('click', openProfileModal)
            // Keyboard accessibility (Enter/Space)
            roleBadgeNav.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault()
                    openProfileModal()
                }
            })
        }
        
        // Ensure text color is white for admin and owner
        if(user.role === 'admin' || user.role === 'owner') {
            roleBadgeNav.style.color = '#ffffff'
        }

        // Show storage link for admin only
        if(user.role === 'admin') {
            // --- Utility: escapeHtml (copied from app.js) ---
            function escapeHtml(s){
                return String(s).replace(/[&<>"']/g, ch=>({
                    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'
                }[ch]))
            }
            document.getElementById('admin-storage-link').style.display = 'block'
        }

        // Show add listing button for owner
        if(user.role === 'owner') {
            document.getElementById('owner-add-listing').style.display = 'block'
        }

        // Load data
        const listings = JSON.parse(localStorage.getItem('unai_listings') || '[]')
        const bookings = JSON.parse(localStorage.getItem('unai_bookings_v1') || '[]')
        const users = auth.getUsers()

        // Show stats
        function renderStats() {
            const statsGrid = document.getElementById('stats-grid')
            
            if(user.role === 'admin') {
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-building" style="font-size:40px;color:#3b82f6"></i></div>
                        <div class="label">‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div class="value">${listings.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-clipboard-list" style="font-size:40px;color:#3b82f6"></i></div>
                        <div class="label">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div class="value">${bookings.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-users" style="font-size:40px;color:#3b82f6"></i></div>
                        <div class="label">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div class="value">${users.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-money-bill-wave" style="font-size:40px;color:#10b981"></i></div>
                        <div class="label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div>
                        <div class="value">${formatPrice(bookings.reduce((sum, b) => sum + (b.total || 0), 0))}</div>
                    </div>
                `
            } else if(user.role === 'owner') {
                const myListings = listings.filter(l => l.owner && l.owner.name === user.username)
                const myBookings = bookings.filter(b => {
                    const listing = listings.find(l => l.id === b.listingId)
                    return listing && listing.owner && listing.owner.name === user.username
                })
                
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-building" style="font-size:40px;color:#3b82f6"></i></div>
                        <div class="label">‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
                        <div class="value">${myListings.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-clipboard-list" style="font-size:40px;color:#3b82f6"></i></div>
                        <div class="label">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div class="value">${myBookings.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-money-bill-wave" style="font-size:40px;color:#10b981"></i></div>
                        <div class="label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div>
                        <div class="value">${formatPrice(myBookings.reduce((sum, b) => sum + (b.total || 0), 0))}</div>
                    </div>
                `
            }
        }

        // Show sections based on role
        if(user.role === 'admin') {
            document.getElementById('admin-listings').style.display = 'block'
            document.getElementById('bookings-section').style.display = 'block'
            document.getElementById('admin-users').style.display = 'block'
            document.getElementById('admin-owner-requests').style.display = 'block'
            document.getElementById('admin-reports').style.display = 'block'
            renderListingsTable()
            renderBookingsTable(bookings)
            renderUsersTable()
            renderOwnerRequestsTable()
            renderReportsTable()
        // --- Admin: Render Reports Table ---
        function renderReportsTable() {
            const tbody = document.getElementById('reports-tbody');
            const reports = JSON.parse(localStorage.getItem('unai_reports') || '[]');
            if(reports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="icon"><i class="fas fa-inbox" style="font-size:64px;color:#9ca3af"></i></div><div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤/‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</div></div></td></tr>';
                return;
            }
            tbody.innerHTML = reports.slice().reverse().map((r, i) => `
                <tr>
                    <td>${new Date(r.time).toLocaleString('th-TH')}</td>
                    <td>${r.username || '-'}</td>
                    <td>${r.email || '-'}</td>
                    <td style="white-space:pre-line;max-width:260px;overflow-x:auto;">
                        ${escapeHtml(r.message)}
                        ${r.reply ? `<div style='margin-top:8px;color:#059669'><b>‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏≠‡∏ö:</b> ${escapeHtml(r.reply)}</div>` : ''}
                    </td>
                    <td>
                        ${r.status === 'pending' ? '<span style="color:#f59e42;font-weight:600">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>' : r.status}
                        ${!r.reply ? `<button class='btn-small btn-edit' onclick='openReplyReportModal(${reports.length-1 - i})'><i class="fas fa-reply"></i> ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // --- Admin: Reply Modal for Reports ---
        function openReplyReportModal(idx) {
            window._replyReportIdx = idx;
            const reports = JSON.parse(localStorage.getItem('unai_reports') || '[]');
            const r = reports[idx];
            document.getElementById('reply-report-message').textContent = r.message;
            document.getElementById('reply-report-reply').value = '';
            document.getElementById('reply-report-modal').style.display = 'flex';
        }
        function closeReplyReportModal() {
            document.getElementById('reply-report-modal').style.display = 'none';
        }
        function submitReplyReport() {
            const idx = window._replyReportIdx;
            const reply = document.getElementById('reply-report-reply').value.trim();
            if(!reply) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö'); return; }
            const reports = JSON.parse(localStorage.getItem('unai_reports') || '[]');
            reports[idx].reply = reply;
            reports[idx].status = 'replied';
            localStorage.setItem('unai_reports', JSON.stringify(reports));
            closeReplyReportModal();
            renderReportsTable();
        }

        } else if(user.role === 'owner') {
            document.getElementById('bookings-section').style.display = 'block'
            const myBookings = bookings.filter(b => {
                const listing = listings.find(l => l.id === b.listingId)
                return listing && listing.owner && listing.owner.name === user.username
            })
            renderBookingsTable(myBookings)
        }

        function renderListingsTable() {
            const tbody = document.getElementById('listings-tbody')
            if(listings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="icon">üì≠</div><div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</div></div></td></tr>'
                return
            }
            
            tbody.innerHTML = listings.map(l => `
                <tr>
                    <td>${l.id}</td>
                    <td>${l.title}</td>
                    <td>${l.type === 'condo' ? 'üè¢ ‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î' : 'üè† ‡∏ö‡πâ‡∏≤‡∏ô'}</td>
                    <td>${l.location}</td>
                    <td>${formatPrice(l.priceMonth || 0)}</td>
                    <td>${l.owner ? l.owner.name : '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-small btn-view" onclick="viewListing('${l.id}')">‡∏î‡∏π</button>
                            <button class="btn-small btn-edit" onclick="editListing('${l.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button class="btn-small btn-delete" onclick="deleteListing('${l.id}')">‡∏•‡∏ö</button>
                        </div>
                    </td>
                </tr>
            `).join('')
        }

        function renderBookingsTable(bookingsToShow) {
            const tbody = document.getElementById('bookings-tbody')
            if(bookingsToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><div class="icon">üì≠</div><div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</div></div></td></tr>'
                return
            }
            
            tbody.innerHTML = bookingsToShow.map(b => {
                const listing = listings.find(l => l.id === b.listingId) || {}
                const title = listing.title || listing.name || b.listingName || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö'
                const coverImage = b.coverImage || listing.coverImage || listing.image || ''
                const coverHtml = coverImage
                    ? `<img src="${coverImage}" alt="${escapeHtml(title)}" style="width:64px;height:48px;object-fit:cover;border-radius:6px;border:1px solid #e5e7eb">`
                    : '<span style="color:#9ca3af">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</span>'
                return `
                    <tr>
                        <td>${b.id}</td>
                        <td>${coverHtml}</td>
                        <td>${escapeHtml(title)}</td>
                        <td>${b.name}</td>
                        <td>${b.email}</td>
                        <td>${b.duration} ${b.period === 'month' ? '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : '‡∏õ‡∏µ'}</td>
                        <td>${formatPrice(b.total || 0)}</td>
                        <td>${new Date(b.createdAt).toLocaleDateString('th-TH')}</td>
                        <td><button class="btn-small btn chat-btn" onclick="openChatModalDashboard('${b.listingId}','${b.name}')">üí¨ ‡πÅ‡∏ä‡∏ó</button></td>
                    </tr>
                `
            }).join('')
        }

        function renderUsersTable() {
            const tbody = document.getElementById('users-tbody');
            if(users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="icon">üì≠</div><div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div></div></td></tr>';
                return;
            }
            const roleIcons = {
                customer: 'üë§',
                owner: 'üè†',
                admin: '‚öôÔ∏è'
            };
            const roleNames = {
                customer: '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤',
                owner: '‡∏ú‡∏π‡πâ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πà‡∏≤',
                admin: 'Admin'
            };
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td><strong>${u.username}</strong></td>
                    <td>${u.email}</td>
                    <td>
                        <span style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:4px 12px;border-radius:12px;font-size:13px">
                            ${roleIcons[u.role] || 'üë§'} ${roleNames[u.role] || u.role}
                        </span>
                    </td>
                    <td>${u.createdAt ? new Date(u.createdAt).toLocaleDateString('th-TH') : '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-small btn-edit" onclick="openEditUserModal('${u.username}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button class="btn-small btn-edit" onclick="changeRole('${u.username}', '${u.role}')">üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</button>
                            <button class="btn-small btn-delete" onclick="deleteUser('${u.username}')">üóëÔ∏è ‡∏•‡∏ö</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function formatPrice(n){
            return new Intl.NumberFormat('th-TH',{style:'currency',currency:'THB',maximumFractionDigits:0}).format(n)
        }

        function viewListing(id) {
            window.location.href = `index.html#listing-${id}`
        }

        function editListing(id) {
            alert('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô')
        }

        function deleteListing(id) {
            if(confirm('‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ô‡∏µ‡πâ?')) {
                alert('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô')
            }
        }

        // Add Listing Modal Functions
        function openAddListingModal() {
            document.getElementById('addListingModal').style.display = 'flex'
            // Reset form
            document.getElementById('addListingForm').reset()
            // Reset image inputs and preview
            const coverFileEl = document.getElementById('listingCoverFile')
            const coverUrlEl = document.getElementById('listingCoverUrl')
            const coverPrev = document.getElementById('listingCoverPreview')
            const coverPrevImg = document.getElementById('listingCoverPreviewImg')
            const fileEl = document.getElementById('listingImageFile')
            const urlEl = document.getElementById('listingImageUrl')
            const prev = document.getElementById('listingImagePreview')
            const prevImg = document.getElementById('listingImagePreviewImg')
            const otherCb = document.getElementById('amenityOther')
            const otherWrapper = document.getElementById('amenities-other-wrapper')
            const otherInput = document.getElementById('listingAmenitiesOther')
            if (coverFileEl) coverFileEl.value = ''
            if (coverUrlEl) coverUrlEl.value = ''
            if (coverPrev && coverPrevImg) { coverPrev.style.display = 'none'; coverPrevImg.src = '' }
            if (fileEl) fileEl.value = ''
            if (urlEl) urlEl.value = ''
            if (prev && prevImg) { prev.style.display = 'none'; prevImg.src = '' }
            if (otherCb) otherCb.checked = false
            if (otherWrapper) otherWrapper.style.display = 'none'
            if (otherInput) otherInput.value = ''
        }

        function closeAddListingModal() {
            document.getElementById('addListingModal').style.display = 'none'
        }

        async function submitAddListing() {
            const form = document.getElementById('addListingForm')
            
            // Validate form
            if (!form.checkValidity()) {
                alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô')
                form.reportValidity()
                return
            }

            // Get amenities
            let amenities = Array.from(document.querySelectorAll('.listing-amenity:checked'))
                .map(cb => cb.value)

            // Include custom amenities from 'Other' input if enabled
            const otherCb = document.getElementById('amenityOther')
            const otherInput = document.getElementById('listingAmenitiesOther')
            if (otherCb && otherCb.checked && otherInput) {
                const extra = otherInput.value
                    .split(',')
                    .map(s => s.trim())
                    .filter(Boolean)
                amenities.push(...extra)
            }

            // De-duplicate
            amenities = Array.from(new Set(amenities))

            // Resolve image from file or URL
            function readFileAsDataURL(file){
                return new Promise((resolve,reject)=>{
                    const reader = new FileReader()
                    reader.onload = ()=> resolve(reader.result)
                    reader.onerror = reject
                    reader.readAsDataURL(file)
                })
            }

            const coverFileInput = document.getElementById('listingCoverFile')
            const coverUrlInput = document.getElementById('listingCoverUrl')
            const coverFile = coverFileInput && coverFileInput.files ? coverFileInput.files[0] : null
            let coverImageData = ''
            if (coverFile) {
                if (coverFile.size > 2 * 1024 * 1024) {
                    alert('‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏õ‡∏Å‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏à‡∏≥‡∏Å‡∏±‡∏î 2MB)')
                    return
                }
                try {
                    coverImageData = await readFileAsDataURL(coverFile)
                } catch (e) {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏õ‡∏Å‡πÑ‡∏î‡πâ')
                    return
                }
            } else if (coverUrlInput && coverUrlInput.value.trim()) {
                coverImageData = coverUrlInput.value.trim()
            } else {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏õ‡∏Å‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏õ‡∏Å')
                return
            }

            const fileInput = document.getElementById('listingImageFile')
            const urlInput = document.getElementById('listingImageUrl')
            const file = fileInput && fileInput.files ? fileInput.files[0] : null
            let imageData = ''
            if (file) {
                if (file.size > 2 * 1024 * 1024) { // 2MB limit
                    alert('‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏à‡∏≥‡∏Å‡∏±‡∏î 2MB)')
                    return
                }
                try {
                    imageData = await readFileAsDataURL(file)
                } catch (e) {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ')
                    return
                }
            } else if (urlInput && urlInput.value.trim()) {
                imageData = urlInput.value.trim()
            }

            // Create new listing object
            const newListing = {
                id: Date.now(),
                name: document.getElementById('listingName').value.trim(),
                type: document.getElementById('listingType').value,
                location: document.getElementById('listingLocation').value.trim(),
                price: parseInt(document.getElementById('listingPrice').value),
                coverImage: coverImageData,
                image: imageData || coverImageData,
                description: document.getElementById('listingDescription').value.trim(),
                bedrooms: parseInt(document.getElementById('listingBedrooms').value),
                bathrooms: parseInt(document.getElementById('listingBathrooms').value),
                size: parseFloat(document.getElementById('listingSize').value),
                coordinates: {
                    lat: parseFloat(document.getElementById('listingLat').value),
                    lng: parseFloat(document.getElementById('listingLng').value)
                },
                amenities: amenities,
                owner: {
                    username: user.username,
                    name: document.getElementById('ownerName').value.trim(),
                    phone: document.getElementById('ownerPhone').value.trim(),
                    line: document.getElementById('ownerLine').value.trim() || '',
                    facebook: document.getElementById('ownerFacebook').value.trim() || '',
                    other: document.getElementById('ownerOtherContact').value.trim() || ''
                },
                createdAt: new Date().toISOString(),
                available: true
            }

            // Save to localStorage
            const currentListings = JSON.parse(localStorage.getItem('unai_listings') || '[]')
            currentListings.push(newListing)
            localStorage.setItem('unai_listings', JSON.stringify(currentListings))

            alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!')
            closeAddListingModal()
            location.reload()
        }

        function deleteUser(username) {
            if(confirm(`‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${username}?`)) {
                const users = auth.getUsers()
                const updated = users.filter(u => u.username !== username)
                auth.saveUsers(updated)
                alert(`‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${username} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`)
                location.reload()
            }
        }

        function changeRole(username, currentRole) {
            // Open modal
            const modal = document.getElementById('roleModal')
            const roleNames = {
                customer: 'üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Customer)',
                owner: 'üè† ‡∏ú‡∏π‡πâ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πà‡∏≤ (Owner)',
                admin: '‚öôÔ∏è Admin (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö)'
            }
            
            document.getElementById('modalUsername').value = username
            document.getElementById('modalCurrentRole').value = roleNames[currentRole] || currentRole
            document.getElementById('modalNewRole').value = ''
            
            modal.classList.add('show')
        }

        function closeRoleModal() {
            const modal = document.getElementById('roleModal')
            modal.classList.remove('show')
        }

        function submitRoleChange() {
            const username = document.getElementById('modalUsername').value
            const currentRoleText = document.getElementById('modalCurrentRole').value
            const newRole = document.getElementById('modalNewRole').value
            
            if (!newRole) {
                alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏´‡∏°‡πà')
                return
            }
            
            // Get current role value from roleNames reverse lookup
            const roleValues = {
                'üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Customer)': 'customer',
                'üè† ‡∏ú‡∏π‡πâ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πà‡∏≤ (Owner)': 'owner',
                '‚öôÔ∏è Admin (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö)': 'admin'
            }
            const currentRole = roleValues[currentRoleText]
            
            if (newRole === currentRole) {
                alert('‚ÑπÔ∏è ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô')
                return
            }
            
            const result = auth.changeUserRole(username, newRole)
            
            if (result.success) {
                alert(`‚úÖ ${result.message}`)
                closeRoleModal()
                location.reload()
            } else {
                alert(`‚ùå ${result.message}`)
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const roleModal = document.getElementById('roleModal')
            const editUserModal = document.getElementById('editUserModal')
            const addListingModal = document.getElementById('addListingModal')
            
            if (event.target === roleModal) {
                closeRoleModal()
            }
            if (event.target === editUserModal) {
                closeEditUserModal()
            }
            if (event.target === addListingModal) {
                closeAddListingModal()
            }
        }

        // Edit User Modal Functions
        function openEditUserModal(username) {
            const users = auth.getUsers()
            const targetUser = users.find(u => u.username === username)
            if (!targetUser) {
                alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ')
                return
            }
            
            document.getElementById('editModalUsername').value = targetUser.username
            document.getElementById('editModalEmail').value = targetUser.email || ''
            document.getElementById('editModalRole').value = targetUser.role || 'customer'
            document.getElementById('editModalPassword').value = ''
            document.getElementById('editModalConfirmPassword').value = ''
            
            document.getElementById('editUserModal').style.display = 'flex'
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none'
        }

        function submitEditUser() {
            const username = document.getElementById('editModalUsername').value
            const email = document.getElementById('editModalEmail').value.trim()
            const role = document.getElementById('editModalRole').value
            const password = document.getElementById('editModalPassword').value
            const confirmPassword = document.getElementById('editModalConfirmPassword').value
            
            // Validate email
            if (!email) {
                alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•')
                return
            }
            
            // Validate password match if provided
            if (password || confirmPassword) {
                if (password !== confirmPassword) {
                    alert('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô')
                    return
                }
                if (password.length < 4) {
                    alert('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£')
                    return
                }
            }
            
            // Call admin edit function
            const updates = { email, role }
            if (password) {
                updates.password = password
            }
            
            const result = auth.adminEditUser(username, updates)
            
            if (result.success) {
                alert(`‚úÖ ${result.message}`)
                closeEditUserModal()
                location.reload()
            } else {
                alert(`‚ùå ${result.message}`)
            }
        }

        // Owner Requests Table
        function renderOwnerRequestsTable() {
            const reqs = auth.getOwnerRequests()
            const tbody = document.getElementById('owner-requests-tbody')
            if(reqs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4"><div class="empty-state"><div class="icon">üì≠</div><div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠</div></div></td></tr>'
                return
            }
            tbody.innerHTML = reqs.map(r => `
                <tr>
                    <td><strong>${r.username}</strong></td>
                    <td>${r.email || '-'}</td>
                    <td>${new Date(r.requestedAt).toLocaleString('th-TH')}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-small btn-edit" onclick="approveOwnerRequest('${r.username}')">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                            <button class="btn-small btn-delete" onclick="rejectOwnerRequest('${r.username}')">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                        </div>
                    </td>
                </tr>
            `).join('')
        }

        function approveOwnerRequest(username) {
            if(!confirm(`‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${username} ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πà‡∏≤?`)) return
            const result = auth.approveOwnerRequest(username)
            alert(result.message)
            if(result.success) {
                renderOwnerRequestsTable()
                renderUsersTable()
            }
        }

        function rejectOwnerRequest(username) {
            if(!confirm(`‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á ${username}?`)) return
            const result = auth.rejectOwnerRequest(username)
            alert(result.message)
            if(result.success) {
                renderOwnerRequestsTable()
            }
        }

        // --- Chat System for Dashboard ---
let currentChatListingIdDashboard = null;
let currentChatCustomerDashboard = null;
function openChatModalDashboard(listingId, customerName) {
    currentChatListingIdDashboard = listingId;
    currentChatCustomerDashboard = customerName;
    document.getElementById('chat-modal-dashboard').setAttribute('aria-hidden', 'false');
    renderChatDashboard();
}
function closeChatModalDashboard() {
    document.getElementById('chat-modal-dashboard').setAttribute('aria-hidden', 'true');
    document.getElementById('chat-input-dashboard').value = '';
    currentChatListingIdDashboard = null;
    currentChatCustomerDashboard = null;
}
function getCurrentUserDashboard() {
    return auth.getLoggedInUser();
}
function getListingOwnerDashboard(listingId) {
    const all = JSON.parse(localStorage.getItem('unai_listings') || '[]');
    return all.find(x => String(x.id) === String(listingId))?.owner || null;
}
function getChatKeyDashboard(listingId, customerName, user) {
    // Key: unai_chat_{listingId}_{customerUsername}_{ownerUsername}
    const owner = getListingOwnerDashboard(listingId);
    if (!user || !owner) return null;
    return `unai_chat_${listingId}_${customerName}_${owner.username}`;
}
function renderChatDashboard() {
    const user = getCurrentUserDashboard();
    const owner = getListingOwnerDashboard(currentChatListingIdDashboard);
    if (!user || !owner) {
        document.getElementById('chat-messages-dashboard').innerHTML = '<div style="color:#dc2626">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</div>';
        return;
    }
    const chatKey = getChatKeyDashboard(currentChatListingIdDashboard, currentChatCustomerDashboard, user);
    const messages = JSON.parse(localStorage.getItem(chatKey) || '[]');
    const box = document.getElementById('chat-messages-dashboard');
    box.innerHTML = '';
    messages.forEach(msg => {
        const div = document.createElement('div');
        div.style.margin = '8px 0';
        div.style.textAlign = msg.sender === user.username ? 'right' : 'left';
        div.innerHTML = `<span style="display:inline-block;padding:8px 14px;border-radius:16px;max-width:70%;background:${msg.sender === user.username ? '#2563eb' : '#f3f4f6'};color:${msg.sender === user.username ? '#fff' : '#222'};font-size:15px;">${escapeHtml(msg.text)}</span><br><span style="font-size:11px;color:#888;">${msg.sender === user.username ? '‡∏Ñ‡∏∏‡∏ì' : msg.sender} ${formatTimeDashboard(msg.time)}</span>`;
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
}
function formatTimeDashboard(iso) {
    const d = new Date(iso);
    return d.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
}
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form-dashboard');
    if (chatForm) {
        chatForm.onsubmit = function(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input-dashboard');
            const text = input.value.trim();
            if (!text) return;
            const user = getCurrentUserDashboard();
            const chatKey = getChatKeyDashboard(currentChatListingIdDashboard, currentChatCustomerDashboard, user);
            if (!chatKey) return;
            const messages = JSON.parse(localStorage.getItem(chatKey) || '[]');
            messages.push({ sender: user.username, text, time: new Date().toISOString() });
            localStorage.setItem(chatKey, JSON.stringify(messages));
            input.value = '';
            renderChatDashboard();
        };
    }
});


function openProfileModal() {
    const user = auth.getLoggedInUser();
    if (!user) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
        return;
    }
    // Use Thai/English role label for consistency
    const roleNames = {
        customer: 'üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Customer)',
        owner: 'üè† ‡∏ú‡∏π‡πâ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πà‡∏≤ (Owner)',
        admin: '‚öôÔ∏è Admin (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö)'
    };
    document.getElementById('profile-username').value = user.username;
    document.getElementById('profile-email').value = user.email;
    document.getElementById('profile-role').value = roleNames[user.role] || user.role;
    document.getElementById('profile-created').value = user.createdAt ? new Date(user.createdAt).toLocaleDateString('th-TH') : '-';
    document.getElementById('profileModal').style.display = 'flex';
}

function closeProfileModal() {
    document.getElementById('profileModal').style.display = 'none';
}

function showEditProfile() {
    document.getElementById('profile-view-mode').style.display = 'none';
    document.getElementById('profile-edit-mode').style.display = 'block';
    const user = auth.getLoggedInUser();
    document.getElementById('edit-profile-username').value = user.username;
    document.getElementById('edit-profile-email').value = user.email;
}

function cancelEditProfile() {
    document.getElementById('profile-edit-mode').style.display = 'none';
    document.getElementById('profile-view-mode').style.display = 'block';
}

document.getElementById('cancel-edit-profile-btn').onclick = cancelEditProfile;

document.getElementById('profile-edit-form').onsubmit = function(e) {
    e.preventDefault();
    const email = document.getElementById('edit-profile-email').value.trim();
    const password = document.getElementById('edit-profile-password').value;
    const confirmPassword = document.getElementById('edit-profile-confirm-password').value;

    if (password && password !== confirmPassword) {
        alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
        return;
    }

    const updates = { email };
    if (password) updates.password = password;

    const result = auth.updateProfile(updates);
    if (result.success) {
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        closeProfileModal();
        location.reload();
    } else {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.message);
    }
};
    </script>
    <script>
    // Live preview for image input
    document.addEventListener('DOMContentLoaded', function(){
        const coverFileEl = document.getElementById('listingCoverFile')
        const coverUrlEl = document.getElementById('listingCoverUrl')
        const coverPrev = document.getElementById('listingCoverPreview')
        const coverPrevImg = document.getElementById('listingCoverPreviewImg')
        const fileEl = document.getElementById('listingImageFile')
        const urlEl = document.getElementById('listingImageUrl')
    const prev = document.getElementById('listingImagePreview')
    const prevImg = document.getElementById('listingImagePreviewImg')
    const amenityOtherCheckbox = document.getElementById('amenityOther')
    const amenityOtherWrapper = document.getElementById('amenities-other-wrapper')
    const amenityOtherInput = document.getElementById('listingAmenitiesOther')
        function showCover(src){
            if (coverPrev && coverPrevImg) {
                coverPrevImg.src = src
                coverPrev.style.display = src ? 'block' : 'none'
            }
        }
        function show(src){
            if (prev && prevImg) {
                prevImg.src = src
                prev.style.display = src ? 'block' : 'none'
            }
        }
        function toggleOtherAmenities(){
            if(!amenityOtherWrapper) return
            if(amenityOtherCheckbox && amenityOtherCheckbox.checked){
                amenityOtherWrapper.style.display = 'block'
                if(amenityOtherInput){
                    amenityOtherInput.focus()
                }
            } else {
                amenityOtherWrapper.style.display = 'none'
                if(amenityOtherInput){
                    amenityOtherInput.value = ''
                }
            }
        }
        if (coverFileEl) {
            coverFileEl.addEventListener('change', () => {
                const f = coverFileEl.files && coverFileEl.files[0]
                if (!f) { showCover(''); return }
                const reader = new FileReader()
                reader.onload = ()=> showCover(reader.result)
                reader.onerror = ()=> showCover('')
                reader.readAsDataURL(f)
            })
        }
        if (coverUrlEl) {
            coverUrlEl.addEventListener('input', () => {
                const val = coverUrlEl.value.trim()
                if (!val) { showCover(''); return }
                showCover(val)
            })
        }
        if (fileEl) {
            fileEl.addEventListener('change', () => {
                const f = fileEl.files && fileEl.files[0]
                if (!f) { show(''); return }
                const reader = new FileReader()
                reader.onload = ()=> show(reader.result)
                reader.onerror = ()=> show('')
                reader.readAsDataURL(f)
            })
        }
        if (urlEl) {
            urlEl.addEventListener('input', () => {
                const val = urlEl.value.trim()
                if (!val) { show(''); return }
                show(val)
            })
        }
        if(amenityOtherCheckbox){
            amenityOtherCheckbox.addEventListener('change', toggleOtherAmenities)
            toggleOtherAmenities()
        }
    })
    </script>
</body>
</html>
